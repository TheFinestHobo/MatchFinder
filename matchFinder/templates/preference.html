{% extends "layout.html" %}

{% block title %}Prioritäten setzen{% endblock %}

{% block header %}Prioritäten setzen{% endblock %}

{% block body %}
<div id="app">
	<h5>Hallo {{teilnehmer.first_name}}, bitte gebe deine Präferenzen an. Du musst mindestens ${neededAnswers} Angaben machen.</h5>
	<form method=post action="{{ url_for('preference.save') }}" enctype=multipart/form-data>
		<div class="col-lg-8 col-md-10 col-sm-12 col-xs-12">
			{% for thema in themen %}
			<div class="input-group mb-2">
				<div class="input-group-prepend w-25">
					<span class="input-group-text w-100">{{thema.thema_name}}</span>
				</div>
				<select @change="onChange($event)" class="form-control custom-select mr-sm-2" tag="selector" name="{{loop.index}}" id="{{loop.index}}">
					<option v-for="(item, index) in validOptions({{loop.index}})">
						${item}
					</option>
				</select>
			</div>
			{% endfor %}
			<input type="hidden" id="information" name="information" value='{"teilnehmer_id": "{{teilnehmer.id}}","verteilung_id":"{{verteilung_id}}"}'>
			<input v-if="allNeededAnswersGiven" class="btn btn-primary" type="submit" value="Speichern">
		</div>
	</form>
</div>
{% endblock %}

{% block scripts %}

<script type="text/javascript">
	var veto = '{"teilnehmerId": "{{teilnehmer.id}}","verteilungId":"{{verteilung_id}}", "veto_allowed":"{{veto_allowed}}", "min_votes": "{{min_votes}}", "numberOfAnswers":"{{themen|length}}"}'
</script>
<script type="text/javascript" src="{{ url_for('static', filename='vue.js') }}"></script>
<script type="text/javascript">


	var app = new Vue({
		el: "#app",
		delimiters: ['${', '}'],
		data: {
			infoJson: null,
			allNeededAnswersGiven: false,
			neededAnswers: 0,

			options : [
			"Keine Präferenz",
			"Erstwahl",
			"Zweitwahl",
			"Drittwahl",
			"Viertwahl",
			"Fünftwahl",
			"Sechstwahl",
			"Siebtwahl",
			"Achtwahl",
			"Neuntwahl",
			"Zehntwahl",
			"Veto",
			],

			mapping: {
				"Keine Präferenz" : "",
				"Erstwahl" : "",
				"Zweitwahl" : "",
				"Drittwahl" : "",
				"Viertwahl" : "",
				"Fünftwahl" : "",
				"Sechstwahl" : "",
				"Siebtwahl" : "",
				"Achtwahl" : "",
				"Neuntwahl" : "",
				"Zehntwahl" : "",
				"Veto" : "",
			}
		},
		methods: {
			configureAnswers() {

				// restrict number of choices
				const numberOfAnswers = this.infoJson["numberOfAnswers"]
				if (numberOfAnswers < 10) {
					const startIndex = parseInt(numberOfAnswers) + 1
					this.options.splice(startIndex, this.options.length - startIndex - 1)
				}
				// configure veto option
				if (this.infoJson["veto_allowed"] == false) {
					delete this.mapping.Veto
					const index = this.options.indexOf("Veto")
					if (index > -1) {
						this.options.splice(index, 1)
					}

				}

			},
			validOptions(object) {
				return this.options.filter(
					f => this.mapping[f] == "" || this.mapping[f] == object
					)
			},
			onChange(event) {
				const value = event.target.value
				const target = event.target
				if (value != this.options[0]) {
					for (var key in this.mapping) {
						if (this.mapping[key] == target.id) {
							this.mapping[key] = ""
						}
					}

					for (var key in this.mapping) {
						if (key == value) {
							this.mapping[key] = target.id
						}
					}

				} else {
					for (var key in this.mapping) {
						if (this.mapping[key] == target.id) {
							this.mapping[key] = ""
						}
					}
				}


				for (i = 1; i <= {{themen | length}}; i++) {

					const element = document.getElementById(i)
					var index = 0
					for (var key in this.mapping) {
						if (this.mapping[key] == element.id) {
							break
						}
						if (this.mapping[key] == "") {
							index++
						}
					}
					if (element.selected != this.options[0] && index < element.options.length) {
						element.options[index].selected = true
					}
				}
				const filtered = this.options.filter(option => this.mapping[option] != "")
				this.allNeededAnswersGiven = filtered.length >= this.neededAnswers
			},
		},
		mounted() {
			var json = JSON.parse(veto)
			json["veto_allowed"] = json["veto_allowed"] == "True" ? true : false
			this.infoJson = json
			this.neededAnswers = json["min_votes"]
			this.configureAnswers()
		}
	})

</script>
{% endblock %}