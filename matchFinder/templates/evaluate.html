{% extends "layout.html" %}

{% block title %}Verteilung auswerten{% endblock %}

{% block header %}Verteilung auswerten{% endblock %}

{% block body %}

{% if error %}

<div class="alert alert-danger" role="alert">
	{{error}}
</div>
{% endif %}

<div id="app" class="mb-5">

	{% if verteilungen %}

	<h5>Wähle eine Verteilung, die du auswerten willst:</h5>

	<div class="col-lg-8 col-md-10 col-sm-12 col-xs-12">
		<form method=post action="{{ url_for('evaluate.from_db') }}" enctype="multipart/form-data">
			<div class="input-group mb-2">
				<div class="input-group-prepend">
					<span class="input-group-text">Gruppen der Verteilung</span>
				</div>
				<select @change="onChange()" class="custom-select" name="verteilung" id="verteilung">
					{% for verteilung in verteilungen %}
					<option value="{{verteilung.id}}">{{verteilung.thema_list.name}}</option>
					{% endfor %}
				</select>
			</div>

			{% for verteilung in verteilungen %}

			<input type="hidden" name="" id="total_verteilung{{verteilung.id}}" value="{{verteilung.teilnehmer.teilnehmer | length}}">
			<input type="hidden" name="" id="current_verteilung{{verteilung.id}}" value="{{verteilung.praeferenzen | length}}">
			<input type="hidden" name="" id="obergrenze{{verteilung.id}}"
			value="{{verteilung.max_teilnehmer_per_thema * verteilung.thema_list.themen|length}}">
			<input type="hidden" name="" id="auslastung{{verteilung.id}}"
			value="{{verteilung.teilnehmer.teilnehmer|length}}">

			{% endfor %}

			<div v-if="(current / total < 0.8)">
				<div class="alert alert-danger" role="alert">
					Von ${total} Teilnehmer haben ${current} ihre Präferenzen angegeben. Sicher, dass du auswerten möchtest?
				</div>
			</div>

			<div v-if="total <= 0">
				<div class="alert alert-danger" role="alert">
					Kein Teilnehmer hat seine Präferenzen für diese Verteilung angegeben.<br>Da dies eine freue Verteilung ist, existiert keine Teilnehmerliste. Sie kann nicht ausgewertet werden.
				</div>
				<div class="input-group mb-2">
					<input class="btn btn-primary" type="submit" value="Auswerten" disabled>
				</div>
			</div>

			<div v-if="! within_limit">
				<div class="alert alert-danger" role="alert">
					Es haben mehr Teilnehmer an der Verteilung teilgenommen, als es Plätze gibt.<br>Die Verteilung kann nicht ausgewertet werden.
				</div>
				<div class="input-group mb-2">
					<input class="btn btn-primary" type="submit" value="Auswerten" disabled>
				</div>
			</div>

			<div v-if="total > 0 && within_limit">
				<div class="input-group mb-2">
					<input class="btn btn-primary" type="submit" value="Auswerten">
				</div>
			</div>

		</form>
	</div>
</div>

{% else %}

<div class="alert alert-danger" role="alert">
	Es existieren keine Verteilungen. Leg schnell eine an:
	<a class="btn btn-primary mx-2" href="/upload">Anlegen</a>
</div>

{% endif %}

<div class="mb-4">
	<h5 class="mb-3">Oder erstelle eine Auswertung aus bereits angegebene Präferenzen in .csv Format</h5>
	<div class="col-lg-8 col-md-10 col-sm-12 col-xs-12">
		<form method=post action="{{ url_for('evaluate.csv_upload') }}" enctype=multipart/form-data>
			<div class="mb-2">
				<input class='button mb' type=file name=file accept=".txt,.csv" required>
			</div>
			<input class="btn btn-primary" type="submit" value="Auswerten">
		</form>
	</div>
</div>

{% endblock %}

{% block scripts %}

<script type="text/javascript" src="{{ url_for('static', filename='vue.js') }}"></script>
<script type="text/javascript">


	var app = new Vue({
		el: "#app",
		delimiters: ['${', '}'],
		data: {
			current: 0,
			total: 0,
			within_limit: true
		},
		methods: {
			update() {
				const selectedValue = document.getElementById("verteilung").value
				if (selectedValue != "None") {
					this.total = document.getElementById("total_verteilung" + selectedValue).value
					this.current = document.getElementById("current_verteilung" + selectedValue).value
					const obergrenze = document.getElementById("obergrenze" + selectedValue).value
					const auslastung = document.getElementById("auslastung" + selectedValue).value
					this.within_limit = auslastung <= obergrenze
				}
			},
			onChange() {
				this.update()
			}
		},
		beforeMount() {
			this.update()
		}
	})

</script>
{% endblock %}